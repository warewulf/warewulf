{{- range $devname, $netdev := .NetDevs }}
{{ file (print "warewulf-" $devname  ".conf") }}
# This file is autogenerated by warewulf

[connection]
id={{ $devname }}
{{- if $netdev.Device }}
interface-name={{ $netdev.Device }}
{{- end }}
type={{ default "ethernet" (lower $netdev.Type) }}
{{- if $netdev.Tags.master }}
master={{ $netdev.Tags.master }}
slave-type=bond
{{- end }}
autoconnect={{ $netdev.OnBoot.BoolDefaultTrue }}

{{- if eq (lower $netdev.Type) "bond" }}
[bond]
downdelay={{ default 0 $netdev.Tags.downdelay }}
miimon={{ default 100 $netdev.Tags.miimon }}
mode={{ default "balance-rr" $netdev.Tags.mode }}
xmit_hash_policy={{ default "layer2+3" $netdev.Tags.xmit_hash_policy }}
updelay={{ default 0 $netdev.Tags.updelay }}
{{- end }}

{{- if eq (lower $netdev.Type) "infiniband" }}
[infiniband]
transport-mode=datagram
{{- if $netdev.MTU }}
mtu={{ $netdev.MTU }}
{{- end }}
{{- else }}
[ethernet]
{{- if $netdev.Hwaddr }}
mac-address={{ $netdev.Hwaddr }}
{{- end }}
{{- if $netdev.MTU }}
mtu={{ $netdev.MTU }}
{{- end }}
{{- end }}

{{- if $netdev.Tags.master }}
[ipv4]
method=disabled

[ipv6]
method=disabled
{{- else }}
[ipv4]
method=manual
{{- if $netdev.IpCIDR }}
address={{ $netdev.IpCIDR }}
{{- end }}
{{- if $netdev.Gateway }}
gateway={{ $netdev.Gateway }}
{{- end }}
{{- $dns := "" }}
{{- range $tk, $tv := $netdev.Tags }}
{{- if regexMatch "^DNS[0-9]*$" $tk }}
{{- $dns = print $dns $tv ";" }}
{{- else if eq (substr 0 5 $tk) "route" }}
{{$tk}}={{$tv}}
{{- end }}
{{- end }}
{{- if $dns }}
dns={{$dns}}
{{- end }}
{{- if $netdev.Tags.DNSSEARCH }}
dns-search={{ join ";" (without (regexSplit "[ ;]+" $netdev.Tags.DNSSEARCH -1) "") }};
{{- end }}

[ipv6]
addr-gen-mode=stable-privacy
method=ignore
never-default=true
{{- if $netdev.Ipaddr6 }}
ipaddr="{{ $netdev.Ipaddr6 }}"
{{- end }}
{{- end }}

{{- if eq $netdev.Type "vlan" }}
[vlan]
{{- if $netdev.Device }}
interface-name={{ $netdev.Device }}
{{- end }}
parent={{ $netdev.Tags.parent_device }}
id={{ $netdev.Tags.vlan_id }}
{{- end }}
{{- end }}
